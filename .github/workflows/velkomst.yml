name: velkomst

on:
  schedule:
    - cron: "1 22 * * *" # 00:01 i Oslo når CEST (UTC+2)
    - cron: "1 23 * * *" # 00:01 i Oslo når CET  (UTC+1)
  workflow_dispatch:
    inputs:
      test_message:
        description: 'Valfritt: skriv ei test-melding (støttar {KLOKKA} og {VÆR}) for å lage test.mp3'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Kjør skript (prod eller test)
        run: node velkomst.js "${{ inputs.test_message }}"
        env:
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          SKILBREI_LAT: ${{ secrets.SKILBREI_LAT }}
          SKILBREI_LON: ${{ secrets.SKILBREI_LON }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          ELEVENLABS_VOICE_ID: ${{ secrets.ELEVENLABS_VOICE_ID }}
          ELEVENLABS_MODEL_ID: ${{ secrets.ELEVENLABS_MODEL_ID }} # f.eks. eleven_multilingual_v3
          LOCATION_NAME: ${{ secrets.LOCATION_NAME }}               # f.eks. Skilbrei (valfritt)
          READABLE_TIME_STYLE: ${{ secrets.READABLE_TIME_STYLE }}   # colon | space | og (valfritt)
          TEST_MESSAGE: ${{ inputs.test_message }}
      - name: Commit velkomst.mp3 (berre når prod)
        if: ${{ inputs.test_message == '' }}
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: oppdatert velkomst.mp3"
          file_pattern: velkomst.mp3
      - name: Last opp artifact (velkomst.mp3)
        if: ${{ inputs.test_message == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: velkomst-mp3
          path: velkomst.mp3
      - name: Last opp artifact (test.mp3)
        if: ${{ inputs.test_message != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: test-mp3
          path: test.mp3
